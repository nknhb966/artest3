<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>AR Polygon Selector</title>
</head>
<body>
  <header>
    <h1>AR Polygon Selector</h1>
    LIB: <a href="https://github.com/code4fukui/egxr.js/">egxr.js</a><br>
  </header>

  <script type="module">
  import { THREE, scene, camera, renderer, ctrls } from "https://code4fukui.github.io/egxr.js/egxr.js";

  let polygon;

  const makeMeshPolygon = (sides = 3) => {
    const geometry = new THREE.BufferGeometry();
    const vertices = [];

    // 頂点座標生成
    for (let i = 0; i < sides; i++) {
      const angle = (i / sides) * Math.PI * 2;
      vertices.push(Math.cos(angle) * 0.1, Math.sin(angle) * 0.1, 0);
    }

    const vertArray = new Float32Array(vertices);
    geometry.setAttribute("position", new THREE.BufferAttribute(vertArray, 3));

    // 面のインデックス生成（三角形分割）
    const indices = [];
    for (let i = 1; i < sides - 1; i++) {
      indices.push(0, i, i + 1);
    }
    geometry.setIndex(indices);

    // ワイヤーフレーム表示
    const material = new THREE.MeshBasicMaterial({
      color: 0xff0000,
      side: THREE.DoubleSide,
      wireframe: true,
    });

    const mesh = new THREE.Mesh(geometry, material);
    mesh.geometry = geometry;
    return mesh;
  };

  // 初期のポリゴン（三角形）
  polygon = makeMeshPolygon(3);
  polygon.position.z = -0.5;
  scene.add(polygon);

  // ドロップダウン風UIの生成
  const menu = new THREE.Group();
  const shapeNames = ["Triangle", "Square", "Pentagon", "Hexagon"];
  const shapeSides = { Triangle: 3, Square: 4, Pentagon: 5, Hexagon: 6 };

  shapeNames.forEach((name, i) => {
    const btnGeo = new THREE.PlaneGeometry(0.15, 0.05);
    const btnMat = new THREE.MeshBasicMaterial({ color: 0x4444ff, side: THREE.DoubleSide });
    const btn = new THREE.Mesh(btnGeo, btnMat);
    btn.position.y = -i * 0.06;
    btn.userData.label = name;
    menu.add(btn);

    // テキスト代わりにボタン上に色で違いを出す（Canvasテキスト追加も可能）
  });

  menu.position.set(0.2, 0, -0.5);
  scene.add(menu);

  const onMenuClick = (ctrl) => {
    for (const child of menu.children) {
      const worldPos = child.getWorldPosition(new THREE.Vector3());
      if (ctrl.position.distanceTo(worldPos) < 0.05) {
        const label = child.userData.label;
        scene.remove(polygon);
        polygon = makeMeshPolygon(shapeSides[label]);
        polygon.position.z = -0.5;
        scene.add(polygon);
      }
    }
  };

  // アニメーションループ（UI判定＆ポリゴン更新）
  renderer.setAnimationLoop((t) => {
    for (const ctrl of ctrls) {
      if (ctrl.selected) {
        onMenuClick(ctrl);
      }
    }

    renderer.render(scene, camera);
  });
  </script>
</body>
</html>
